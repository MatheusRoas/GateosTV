<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GATEOSTV ‚Äì Player Familiar üê±</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        body { font-family: sans-serif; background: #0a0a0a; color: #fff; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* TELA INICIAL (UPLOAD) */
        #upload-screen {
            position: fixed; inset: 0; background: #050505; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
            padding: 20px;
        }
        #upload-screen h1 { color: #c00; font-family: 'Fredoka One', cursive; font-size: 40px; margin-bottom: 10px; }
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; margin-top: 20px; }
        .btn-upload {
            border: 2px solid #c00; color: white; background-color: #000;
            padding: 15px 30px; border-radius: 8px; font-size: 20px; font-weight: bold; cursor: pointer;
        }
        .btn-upload:hover { background: #c00; }
        #upload-screen input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        #status-msg { margin-top: 20px; color: #888; }

        /* PLAYER E INTERFACE */
        #app { display: none; flex-direction: column; height: 100%; }
        
        #player-wrapper { flex-shrink: 0; background: #000; width: 100%; position: sticky; top: 0; z-index: 100;}
        video { width: 100%; max-height: 40vh; display: block; }
        
        #controls { padding: 10px; background: #111; display: flex; gap: 10px; align-items: center; }
        #search { flex-grow: 1; padding: 12px; border-radius: 5px; border: none; background: #222; color: white; font-size: 16px; }
        #reset-btn { background: #333; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;}

        #channel-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .channel-btn { 
            display: block; width: 100%; padding: 15px; margin-bottom: 5px; 
            background: #1a1a1a; color: #ccc; border: none; text-align: left; 
            cursor: pointer; font-size: 15px; border-radius: 5px; border-left: 4px solid #333;
        }
        .active { background: #c00; color: white; border-left: 4px solid #fff; }

        /* AVISO CHROMECAST */
        .cast-note { font-size: 12px; color: #666; text-align: center; padding: 5px; background: #000; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>

    <div id="upload-screen">
        <h1>üê± GATEOS TV</h1>
        <p>Selecione o arquivo da lista (.m3u) para come√ßar</p>
        
        <div class="upload-btn-wrapper">
            <button class="btn-upload">üìÇ Abrir Lista</button>
            <input type="file" id="fileInput" accept=".m3u,.m3u8,.txt">
        </div>
        <p id="status-msg">Nenhuma lista carregada.</p>
    </div>

    <div id="app">
        <div id="player-wrapper">
            <video id="video" controls autoplay playsinline></video>
            <div class="cast-note">üì∫ Para transmitir: Use a op√ß√£o "Transmitir" do menu do navegador</div>
        </div>
        
        <div id="controls">
            <input type="text" id="search" placeholder="üîç Buscar canal (ex: Premiere, HBO...)" onkeyup="filtrar()">
            <button id="reset-btn" onclick="location.reload()">Sair</button>
        </div>
        
        <div id="channel-list"></div>
    </div>

    <script>
        let todosCanais = [];
        const fileInput = document.getElementById('fileInput');
        const statusMsg = document.getElementById('status-msg');
        const listContainer = document.getElementById('channel-list');
        const video = document.getElementById('video');

        // 1. LER O ARQUIVO DO USU√ÅRIO
        fileInput.addEventListener('change', function(e) {
            const arquivo = e.target.files[0];
            if (!arquivo) return;

            statusMsg.innerText = "Lendo arquivo... (Aguarde)";
            statusMsg.style.color = "yellow";

            const leitor = new FileReader();
            
            leitor.onload = function(e) {
                const conteudo = e.target.result;
                if(conteudo.includes("#EXTM3U")) {
                    processarLista(conteudo);
                } else {
                    statusMsg.innerText = "Erro: Isso n√£o parece uma lista M3U v√°lida!";
                    statusMsg.style.color = "red";
                }
            };
            
            leitor.onerror = function() {
                statusMsg.innerText = "Erro ao ler o arquivo!";
            };

            leitor.readAsText(arquivo);
        });

        // 2. PROCESSAR A LISTA (OTIMIZADO)
        function processarLista(texto) {
            todosCanais = [];
            const lines = texto.split('\n');
            let nomeAtual = "";

            statusMsg.innerText = "Organizando canais... (Quase l√°)";

            // Timeout para dar tempo da interface atualizar antes de travar processando
            setTimeout(() => {
                for (let i = 0; i < lines.length; i++) {
                    let linha = lines[i].trim();
                    if (linha.startsWith('#EXTINF')) {
                        let partes = linha.split(',');
                        nomeAtual = partes[partes.length - 1] || 'Sem Nome';
                    } else if (linha.startsWith('http')) {
                        if (nomeAtual) {
                            todosCanais.push({ nome: nomeAtual, url: linha });
                            nomeAtual = "";
                        }
                    }
                }

                // Troca de tela
                if (todosCanais.length > 0) {
                    document.getElementById('upload-screen').style.display = 'none';
                    document.getElementById('app').style.display = 'flex';
                    renderizar(todosCanais.slice(0, 50)); // Mostra os primeiros 50
                } else {
                    statusMsg.innerText = "Nenhum canal encontrado na lista!";
                    statusMsg.style.color = "red";
                }
            }, 100);
        }

        // 3. RENDERIZAR NA TELA
        function renderizar(lista) {
            listContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            
            lista.forEach(canal => {
                const btn = document.createElement('button');
                btn.className = 'channel-btn';
                btn.innerText = canal.nome;
                btn.onclick = () => tocar(canal.url, btn);
                fragment.appendChild(btn);
            });
            listContainer.appendChild(fragment);

            if(lista.length === 0) listContainer.innerHTML = '<p style="text-align:center; padding:20px">Nada encontrado.</p>';
        }

        // 4. BUSCA (COM DELAY PARA N√ÉO TRAVAR)
        let timerBusca;
        function filtrar() {
            clearTimeout(timerBusca);
            timerBusca = setTimeout(() => {
                const termo = document.getElementById('search').value.toLowerCase();
                if (termo.length < 2) {
                    renderizar(todosCanais.slice(0, 50));
                } else {
                    const filtrados = todosCanais.filter(c => c.nome.toLowerCase().includes(termo)).slice(0, 100);
                    renderizar(filtrados);
                }
            }, 300);
        }

        // 5. TOCAR V√çDEO
        function tocar(url, btn) {
            document.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.play();
            }
        }
    </script>
</body>
</html>
