<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GATEOSTV ‚Äì Madrid üê±üá™üá∏</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #d32f2f; --bg: #0a0a0a; --text: #e0e0e0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* TELA DE CARGA */
        #loading-screen {
            position: fixed; inset: 0; background: #000; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* PLAYER */
        #video-area { flex-shrink: 0; background: black; position: sticky; top: 0; z-index: 100; border-bottom: 2px solid var(--primary); }
        video { width: 100%; max-height: 35vh; display: block; }
        
        /* CONTROLES */
        #controls { padding: 10px; background: #111; display: flex; flex-direction: column; gap: 10px; }
        select, input { padding: 12px; background: #222; border: 1px solid #333; color: white; border-radius: 6px; width: 100%; box-sizing: border-box; }
        select { font-weight: bold; color: var(--primary); }

        /* LISTA */
        #channel-list { flex-grow: 1; overflow-y: auto; }
        .channel-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #222; }
        .channel-row:hover { background: #1a1a1a; }
        .channel-row.active { background: #1a0505; border-left: 4px solid var(--primary); }
        
        .btn-vlc { background: #ff9800; color: #000; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-weight: bold; font-size: 12px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>

    <div id="loading-screen">
        <h1 style="font-family: 'Fredoka One'; color: #d32f2f;">GATEOSTV</h1>
        <div class="spinner"></div>
        <p id="status-msg" style="color:#666; margin-top:10px">Baixando lista do servidor...</p>
    </div>

    <div id="app" style="display:none; flex-direction:column; height:100%">
        <div id="video-area">
            <video id="video" controls autoplay playsinline></video>
        </div>

        <div id="controls">
            <select id="groupSelect" onchange="filtrar()">
                <option value="TODOS">üåç TODOS OS CANAIS</option>
            </select>
            <input type="text" id="searchInput" placeholder="üîç Buscar canal..." onkeyup="filtrar()">
        </div>

        <div id="channel-list"></div>
    </div>

    <script>
        // ENDERE√áO DO SEU SERVIDOR
        const URL_SERVIDOR = "https://gateostv-proxy.onrender.com/minhalista";

        let todosCanais = [];
        let categorias = new Set();
        const video = document.getElementById('video');
        const listContainer = document.getElementById('channel-list');
        const statusMsg = document.getElementById('status-msg');

        // AO INICIAR
        window.addEventListener('DOMContentLoaded', () => {
            fetch(URL_SERVIDOR)
                .then(res => {
                    if (!res.ok) throw new Error("Erro ao baixar lista (Verifique se o arquivo est√° no Render)");
                    return res.text();
                })
                .then(texto => processarLista(texto))
                .catch(err => {
                    statusMsg.innerText = "Erro: " + err.message;
                    statusMsg.style.color = "red";
                });
        });

        function processarLista(texto) {
            todosCanais = [];
            categorias.clear();
            const linhas = texto.split('\n');
            let nome = "", grupo = "GERAL";

            for(let linha of linhas) {
                linha = linha.trim();
                if(linha.startsWith("#EXTINF")) {
                    // Pega o grupo (Category)
                    let match = linha.match(/group-title="([^"]*)"/i);
                    grupo = match ? match[1] : "GERAL";
                    categorias.add(grupo);
                    
                    // Pega o nome (depois da v√≠rgula)
                    let partes = linha.split(',');
                    nome = partes[partes.length - 1] || "Sem Nome";
                } else if(linha.startsWith("http")) {
                    if(nome) {
                        todosCanais.push({ nome, grupo, url: linha });
                    }
                }
            }

            if(todosCanais.length > 0) {
                montarSelect();
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                filtrar();
            } else {
                statusMsg.innerText = "Lista vazia ou formato inv√°lido!";
            }
        }

        function montarSelect() {
            const sel = document.getElementById('groupSelect');
            // Ordena categorias alfabeticamente
            Array.from(categorias).sort().forEach(cat => {
                let opt = document.createElement('option');
                opt.value = cat; 
                opt.innerText = "üìÇ " + cat;
                sel.appendChild(opt);
            });
        }

        let timer;
        function filtrar() {
            clearTimeout(timer);
            timer = setTimeout(() => {
                const grp = document.getElementById('groupSelect').value;
                const txt = document.getElementById('searchInput').value.toLowerCase();
                
                const res = todosCanais.filter(c => 
                    (grp === 'TODOS' || c.grupo === grp) && 
                    c.nome.toLowerCase().includes(txt)
                );
                
                // Mostra s√≥ os primeiros 100 pra n√£o travar o celular
                renderizar(res.slice(0, 100));
            }, 300);
        }

        function renderizar(lista) {
            listContainer.innerHTML = "";
            lista.forEach(c => {
                const div = document.createElement('div');
                div.className = 'channel-row';
                
                // Link direto para VLC (For√ßa abrir app externo)
                const vlcLink = `vlc://${c.url}`;

                div.innerHTML = `
                    <div style="flex:1" onclick="tocar('${c.url}', this)">
                        <div style="font-weight:bold">${c.nome}</div>
                        <div style="font-size:12px; color:#666">${c.grupo}</div>
                    </div>
                    <a href="${vlcLink}" class="btn-vlc">VLC</a>
                `;
                listContainer.appendChild(div);
            });
        }

        function tocar(url, el) {
            document.querySelectorAll('.channel-row').forEach(r => r.classList.remove('active'));
            el.parentElement.classList.add('active');
            
            if (Hls.isSupported()) {
                const hls = new Hls(); hls.loadSource(url); hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url; video.play();
            }
        }
    </script>
</body>
</html>
